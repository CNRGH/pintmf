---
title: "BXD data"
author: Morgane Pierre-Jean
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Useful packages
```{r, library}
library(Matrix)
library(tidyverse)
library(PintMF)
library(CrIMMix)
library(future)
```

Run Bxd 


```{r}
library(CrIMMixdata)
data(bxd)
```

```{r}
str(bxd)
remove_affy <- grep("Affy", colnames(bxd[[3]]))
bxd_filtered <- bxd
bxd_filtered[[3]] <- bxd_filtered[[3]][, -remove_affy]
true.clust.bxd <- rep(c("CD", "HFD"), times=c(33, 31))
```


```{r}
MoClusterresults <- IntMultiOmics(bxd_filtered, method = "Mocluster", K=2, k=c(0.4,0.4,0.4))
```


```{r}
R_bxd <- lapply(2:8, function(p) PintMF::SolveInt(Y=bxd_filtered, p=p,
                                                  max.it=1,
                                                  verbose=TRUE,
                                                  init_flavor="snf",
                                                  flavor_mod="glmnet"))


RSS_data_mat <- sapply(R_bxd, computeLL, Y=bxd_filtered)
RSS_data <-  RSS_data_mat %>% t %>% data.frame
ggplot(data = RSS_data, aes(x = p, y = RSS)) + geom_point()
```


```{r}

BIC <- sapply(seq(from=0.1, to =2, length=10), function (pen) apply(RSS_data_mat, 2, compute_BIC, pen = pen)[1,])
RSS_data <-  RSS_data_mat %>% t %>% data.frame %>% cbind(BIC= BIC) %>% pivot_longer( cols = starts_with("BIC"), names_to = "BIC")

a            <- range(RSS_data[["RSS"]])
b            <- range(RSS_data[["value"]])
scale_factor <- diff(a)/diff(b)
RSS_data[["value"]]      <- ((RSS_data[["value"]]   - b[1]) * scale_factor) + a[1]
trans <- ~ ((. - a[1]) / scale_factor) + b[1]

ggplot(data = RSS_data, aes(x = p)) +theme_bw()+geom_line(aes(y = value))+geom_line(aes(y = RSS), col="red")+facet_wrap(.~BIC, scale="free")
```

```{r}
loss <- sapply(R_bxd, function (rr){
  W <- rr$W
  l <- sapply(1:length(rr$H), function (ii) {
    h <- rr$H[[ii]]
    y <- bxd_filtered[[ii]]
    sum((y-W%*%h)^2)/(nrow(W)*nrow(y))
  })
  mean(l)
})
loss_W <- sapply(R_bxd, function (rr){
  W <- rr$W
  sum(W^2)/ncol(W)
})

iteration <- 2:8
df_pve <- data.frame(lossW=loss_W, iteration=iteration, loss= loss, pve= sapply(R_bxd, function (r) r$pve))
pen <- 2*(sapply(bxd_filtered, sd) %>% mean)
g1 <- ggplot(df_pve, aes(x=iteration, y=loss))+geom_point()+theme_bw()+geom_line()+scale_x_continuous(breaks=1:10)
g2 <- ggplot(df_pve, aes(x=iteration, y=lossW))+geom_point()+theme_bw()+geom_line()+scale_x_continuous(breaks=1:10)
g3 <- ggplot(df_pve, aes(x=iteration, y=pve))+geom_point()+theme_bw()+geom_line()+scale_x_continuous(breaks=1:10)+ylim(c(90,100))
grid.arrange(g1,g2,g3, ncol=3)
```


```{r}
my_meth <- SolveInt(Y=bxd_filtered, p=2, max.it=1,verbose=TRUE,init_flavor="snf",flavor_mod="glmnet")
```

```{r, pve}
df_pve <- data.frame(pve=my_meth$pve, iteration=1:length(my_meth$pve))
ggplot(df_pve, aes(x=iteration, y=pve))+geom_point()+theme_bw()+geom_line()+ylim(c(0,max(df_pve$pve)))

df_loss <- data.frame(loss=my_meth$loss[-1], iteration=2:length(my_meth$loss))
ggplot(df_loss, aes(x=iteration, y=loss))+geom_point()+theme_bw()+geom_line()
```

```{r}
cols <- RColorBrewer::brewer.pal(4, "Set1")
clust <- my_meth$W %>% dist %>% hclust(method="ward.D2") %>% cutree(2)
table(true.clust.bxd, clust)
library(RColorBrewer)
pal <- rev(RColorBrewer::brewer.pal(5, "RdBu"))
gplots::heatmap.2(my_meth$W, scale="none", trace="none",RowSideColors = cols[as.factor(true.clust.bxd)],
                  col = pal)
```



```{r}
est_multiom <- lapply(1:length(bxd_filtered), function (ii) {
  rr <- my_meth$H[[ii]]
  rr%>% 
    apply(1,FUN=function(x) which(abs(x)>quantile(abs(x), 0.90)) %>% names)
})

ndat <- data %>% length
J <- sapply(data, ncol)
```


## ROC Figures

```{r, roc_multiom, fig.width=7}
H_transformed <- my_meth$H
H_coef <- lapply(H_transformed, function (hh) {
  s <- matrixStats::colSds((hh))
  names(s) <- colnames(hh)
  s
})

H_sorted <- lapply(H_coef, sort,decreasing = TRUE) %>% lapply(names) %>% lapply(unique)

```

```{r}
library(ComplexHeatmap)

col.clust <- RColorBrewer::brewer.pal(7, "Set2")[c(4,5, 6, 7)]
clust_col = structure(names = c("1", "2", "3", "4"),col.clust)
col.true <- RColorBrewer::brewer.pal(6, "Set3")[c(5,6)]
true_col = structure(names = c("CD", "HFD"),col.true)
for( i in 1:length(bxd_filtered)){
  mat <- bxd_filtered[[i]][, H_sorted[[i]][1:10]] %>% t
  f2 = circlize::colorRamp2(seq(min(mat), max(mat), length = 3), c("blue", "#EEEEEE", "red"),
                            space = "RGB")
  ha = HeatmapAnnotation(PintMF = clust,
                         Truth = true.clust.bxd,
                         col = list( PintMF=clust_col, Truth=true_col),
                         show_legend = rep(FALSE, 9),
                         show_annotation_name = TRUE,
  )
  ht <- Heatmap(mat,col = f2,
                show_row_dend = FALSE,
                show_column_dend = FALSE,
                cluster_columns=FALSE,
                row_names_gp = gpar(fontsize =10),
                column_names_gp = gpar(col=rep(col.true,c(33,31)), fontsize =7),
                show_column_names = FALSE,
                top_annotation = ha,
                name = names(bxd_filtered)[i])
  pdf(sprintf("PintMF_heatmap_%s.pdf", names(bxd_filtered)[i]), width = 8, height = 8)
  draw(ht,
       annotation_legend_side = "left", heatmap_legend_side = "left")
  dev.off()

}
```

